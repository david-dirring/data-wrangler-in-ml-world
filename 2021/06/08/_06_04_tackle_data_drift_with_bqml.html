<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Tackle Data Drift in your ML pipeline | David Dirring’s Data Science &amp; Machine Learning Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Tackle Data Drift in your ML pipeline" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A practical &amp; easy method to detect when you have data issues in your machine learning pipeline." />
<meta property="og:description" content="A practical &amp; easy method to detect when you have data issues in your machine learning pipeline." />
<link rel="canonical" href="https://david-dirring.github.io/data-wrangler-in-ml-world/2021/06/08/_06_04_tackle_data_drift_with_bqml.html" />
<meta property="og:url" content="https://david-dirring.github.io/data-wrangler-in-ml-world/2021/06/08/_06_04_tackle_data_drift_with_bqml.html" />
<meta property="og:site_name" content="David Dirring’s Data Science &amp; Machine Learning Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-08T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"A practical &amp; easy method to detect when you have data issues in your machine learning pipeline.","url":"https://david-dirring.github.io/data-wrangler-in-ml-world/2021/06/08/_06_04_tackle_data_drift_with_bqml.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://david-dirring.github.io/data-wrangler-in-ml-world/2021/06/08/_06_04_tackle_data_drift_with_bqml.html"},"headline":"Tackle Data Drift in your ML pipeline","dateModified":"2021-06-08T00:00:00-05:00","datePublished":"2021-06-08T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/data-wrangler-in-ml-world/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://david-dirring.github.io/data-wrangler-in-ml-world/feed.xml" title="David Dirring's Data Science &amp; Machine Learning Blog" /><link rel="shortcut icon" type="image/x-icon" href="/data-wrangler-in-ml-world/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/data-wrangler-in-ml-world/">David Dirring&#39;s Data Science &amp; Machine Learning Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/data-wrangler-in-ml-world/about/">About Me</a><a class="page-link" href="/data-wrangler-in-ml-world/search/">Search</a><a class="page-link" href="/data-wrangler-in-ml-world/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tackle Data Drift in your ML pipeline</h1><p class="page-description">A practical & easy method to detect when you have data issues in your machine learning pipeline.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-06-08T00:00:00-05:00" itemprop="datePublished">
        Jun 8, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/david-dirring/data-wrangler-in-ml-world/tree/master/_notebooks/2021_06_04_tackle_data_drift_with_bqml.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/data-wrangler-in-ml-world/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/david-dirring/data-wrangler-in-ml-world/master?filepath=_notebooks%2F2021_06_04_tackle_data_drift_with_bqml.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/data-wrangler-in-ml-world/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/2021_06_04_tackle_data_drift_with_bqml.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/data-wrangler-in-ml-world/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021_06_04_tackle_data_drift_with_bqml.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/No_More_Just_Hoping.png?raw=1" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>LEFT SIDE OF IMAGE BELOW:</strong> When we learn about machine learning, we typically do the left side of the figure below. We get the data, we add features, we train, we hold out on some data, and see how we would do on that holdout set. What we don't learn about is how we should SAVE down that model file somewhere so that your "test-inference" process can pick it up later.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>RIGHT SIDE OF IMAGE BELOW</strong>: Before my process grabs the model file to make predictions on my test-inference data, I need to be sure that this data looks similar enough to the data that the model trained on. If you do not check this, you run the risk of decreasing your accuracy. I will explain how I do this below in BigQuery.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/no_more_just_hoping_data_is_right_training_and_inference.png?raw=1" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simple-BQML-Script-&amp;-Model-to-Alert-You-To-Data-Issues">Simple BQML Script &amp; Model to Alert You To Data Issues<a class="anchor-link" href="#Simple-BQML-Script-&amp;-Model-to-Alert-You-To-Data-Issues"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I have been wrangling data and data storytelling for over 13 years. 
I love BigQuery. I love how fast &amp; powerful it is. I also love the work they are putting into BQML.</p>
<p>For this demonstration, I will pull in a dataset from a BigQuery public dataset -- Daily Liquor Sales in Iowa. We can pretend that we work at a government agency in Iowa and our boss needs us to predict liquor sales by THE GALLON haha. Not realistic, but fun to think about.</p>
<p>The script below will roughly follow these steps:</p>
<ol>
<li><strong>Build</strong> a table using a query to pull from bigquery-public-data</li>
<li><strong>Split</strong> table into chunks for train / test / validation / test-inference. In real life, you'll have a process to update the test-inference dataset. The "train / test / validation" is the left side of image above. The "test-inference" is right side.</li>
<li><strong>Grab 10k records</strong> from train and from test-inference.</li>
<li>Build simple <strong>BQML model</strong> to predict which records are from "train" (0) or from "test-inference" (1)</li>
<li>Look at AUC of simple model to determine if there are data issues. <strong>Fail query if AUC is above your threshold</strong>. I have found .6 or .65 work as a good threshold. AUC of .5 is basically completely random guesses, which implies that the model cannot discern which records are train and which are test-inference.</li>
<li>If issue, then <strong>return the features</strong> that are contributing to the data 
issue.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Steps-1-&amp;-2:"><strong>Steps 1 &amp; 2:</strong><a class="anchor-link" href="#Steps-1-&amp;-2:"> </a></h3><p><img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/no_more_just_hoping_query_time_periods_join.png?raw=1" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Output from query above to help you understand the data: 
  <img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/no_more_just_hoping_20_random_rows.png?raw=1" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Steps-3-&amp;-4:-BQML-script-to-create-the-model-to-determine-if-there-are-data-issues:"><strong>Steps 3 &amp; 4:</strong> BQML script to create the model to determine if there are data issues:<a class="anchor-link" href="#Steps-3-&amp;-4:-BQML-script-to-create-the-model-to-determine-if-there-are-data-issues:"> </a></h3><p><img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/no_more_just_hoping_10k_random_rows_union_together.png?raw=1" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-5:-Check-AUC-&amp;-fail-if-above-threshold:"><strong>Step 5:</strong> Check AUC &amp; fail if above threshold:<a class="anchor-link" href="#Step-5:-Check-AUC-&amp;-fail-if-above-threshold:"> </a></h3><p><img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/no_more_just_hoping_error_running_query.png?raw=1" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Steps-6:-return-top-contributing-features:"><strong>Steps 6:</strong> return top contributing features:<a class="anchor-link" href="#Steps-6:-return-top-contributing-features:"> </a></h3><p><img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/no_more_just_hoping_auc_is_bad.png?raw=1" alt="" /></p>
<p>if AUC is below .65, then no issues.
  <img src="https://github.com/david-dirring/data-wrangler-in-ml-world/blob/master/_notebooks/my_icons/no_more_just_hoping_auc_is_fine.png?raw=1" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="In-Closing"><strong>In Closing</strong><a class="anchor-link" href="#In-Closing"> </a></h3><p>I have implemented this process at work. I honestly sleep better knowing that I have this failsafe in place. We have to pull from over 25+ different sources for 120 or so features. If we mess something up or if an ETL process fails upstream before it gets to our process, it is wonderful to know right away instead of just watching performance plummet or watch it bounce around a day or two later.</p>
<p>Please reach out on Twitter or LinkedIn if you have any questions.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you would like to look at the full script, please follow this link (coming!)</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/data-wrangler-in-ml-world/2021/06/08/_06_04_tackle_data_drift_with_bqml.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/data-wrangler-in-ml-world/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/data-wrangler-in-ml-world/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/data-wrangler-in-ml-world/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Data wrangler at heart, trying to make it work in a ML World. I will be using this blog to help document my journey.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/david-dirring" title="david-dirring"><svg class="svg-icon grey"><use xlink:href="/data-wrangler-in-ml-world/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/ddirring" title="ddirring"><svg class="svg-icon grey"><use xlink:href="/data-wrangler-in-ml-world/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/DavidDirring" title="DavidDirring"><svg class="svg-icon grey"><use xlink:href="/data-wrangler-in-ml-world/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
